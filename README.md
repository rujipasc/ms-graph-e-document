# SPD eDocument Processing Pipeline

р╕гр╕░р╕Ър╕Ър╕Щр╕╡р╣Йр╕нр╕нр╕Бр╣Бр╕Ър╕Ър╕бр╕▓р╣Ар╕Юр╕╖р╣Ир╕нр╕гр╕▒р╕Ъ ZIP р╕Ир╕▓р╕Бр╣Вр╕Яр╕ер╣Ар╕Фр╕нр╕гр╣М Staging р╕Ър╕Щ OneDrive, р╣Бр╕Ыр╕ер╕Зр╣Ар╕нр╕Бр╕кр╕▓р╕гр╣Ар╕Ыр╣Зр╕Щ PDF р╕Юр╕гр╣Йр╕нр╕бр╕Фр╕╢р╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Юр╕Щр╕▒р╕Бр╕Зр╕▓р╕Щ, р╕нр╕▒р╕Ыр╣Вр╕лр╕ер╕Фр╕Вр╕╢р╣Йр╕Щ SharePoint р╣Бр╕ер╕░р╕кр╕гр╕╕р╕Ыр╕Ьр╕ер╕Бр╕▓р╕гр╕Чр╕│р╕Зр╕▓р╕Щр╕Ьр╣Ир╕▓р╕Щр╕нр╕╡р╣Ар╕бр╕ер╕гр╕▓р╕вр╕зр╕▒р╕Щ

## р╕Др╕╕р╕Ур╕кр╕бр╕Ър╕▒р╕Хр╕┤р╕лр╕ер╕▒р╕Б
- р╕Фр╕▓р╕зр╕Щр╣Мр╣Вр╕лр╕ер╕Ф ZIP р╕Хр╕▓р╕бр╕Чр╕╡р╕бр╕Ир╕▓р╕Б OneDrive р╣Бр╕ер╣Йр╕зр╣Бр╕Хр╕Бр╣Др╕Яр╕ер╣М (р╕гр╕нр╕Зр╕гр╕▒р╕Ър╕гр╕лр╕▒р╕кр╕Ьр╣Ир╕▓р╕Щ)
- р╣Бр╕Ыр╕ер╕Зр╣Др╕Яр╕ер╣Мр╕гр╕╣р╕Ы (JPG/PNG/TIFF) р╣Ар╕Ыр╣Зр╕Щ PDF, р╕гр╕зр╕б PDF р╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Ф р╣Бр╕ер╕░р╕Хр╕▒р╣Йр╕Зр╕Кр╕╖р╣Ир╕нр╣Др╕Яр╕ер╣Мр╕Ир╕▓р╕Бр╕Бр╕Хр╕┤р╕Бр╕▓ EmpID
- р╣Ар╕Хр╕┤р╕бр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Юр╕Щр╕▒р╕Бр╕Зр╕▓р╕Щр╕Ир╕▓р╕Бр╕Рр╕▓р╕Щр╕Вр╣Йр╕нр╕бр╕╣р╕е MySQL р╣Бр╕ер╕░р╕Ър╕▒р╕Щр╕Чр╕╢р╕Бр╕кр╕гр╕╕р╕Ыр╣Гр╕Щ `output/summary.csv`
- р╕нр╕▒р╕Ыр╣Вр╕лр╕ер╕Ф PDF р╣Др╕Ыр╕вр╕▒р╕З SharePoint р╕Юр╕гр╣Йр╕нр╕бр╕кр╕гр╣Йр╕▓р╕Зр╣Вр╕Яр╕ер╣Ар╕Фр╕нр╕гр╣Мр╕вр╣Ир╕нр╕вр╣Бр╕ер╕░ Patch metadata
- р╕кр╣Ир╕Зр╕нр╕╡р╣Ар╕бр╕ер╕кр╕гр╕╕р╕Ыр╕Ьр╕ер╣Гр╕лр╣Йр╕Ьр╕╣р╣Йр╕кр╣Бр╕Бр╕Щр╣Бр╕Хр╣Ир╕ер╕░р╕Др╕Щ р╕Юр╕гр╣Йр╕нр╕бр╣Бр╕Щр╕Ъ CSV р╕Чр╕╡р╣Ир╕бр╕╡р╕ер╕┤р╕Зр╕Бр╣М SharePoint р╕Вр╕нр╕Зр╣Др╕Яр╕ер╣М
- р╣Ар╕Бр╣Зр╕Ъ Log р╕Бр╕▓р╕гр╕Чр╕│р╕Зр╕▓р╕Щр╣Бр╕ер╕░р╣Бр╕вр╕Бр╕Ър╕▒р╕Щр╕Чр╕╢р╕Бр╕Вр╣Йр╕нр╕Ьр╕┤р╕Фр╕Юр╕ер╕▓р╕Фр╕гр╕▓р╕вр╣Ар╕Фр╕╖р╕нр╕Щ

## р╣Вр╕Др╕гр╕Зр╕кр╕гр╣Йр╕▓р╕Зр╣Др╕Фр╣Ар╕гр╕Бр╕Чр╕нр╕гр╕╡р╣Вр╕Фр╕вр╕вр╣Ир╕н
```
config/           # team.json, mapping.json р╕кр╕│р╕лр╕гр╕▒р╕Ъ role/event
src/
  services/       # runPipeline, sendSummary, summary helper р╕пр╕ер╕п
  integrations/   # Graph, SharePoint, OneDrive, Entra helpers
  core/           # zip/image/pdf helper, naming, db
output/           # summary.csv + р╣Др╕Яр╕ер╣М CSV р╕Чр╕╡р╣Ир╕Ир╕░р╕Цр╕╣р╕Бр╣Бр╕Щр╕Ър╕нр╕╡р╣Ар╕бр╕е (р╕Цр╕╣р╕Бр╕ер╣Йр╕▓р╕Зр╕лр╕ер╕▒р╕Зр╕Ир╕Ър╕Зр╕▓р╕Щ)
staging/, temp/   # р╣Вр╕Яр╕ер╣Ар╕Фр╕нр╕гр╣Мр╕Кр╕▒р╣Ир╕зр╕Др╕гр╕▓р╕зр╕кр╕│р╕лр╕гр╕▒р╕Ър╕Ыр╕гр╕░р╕бр╕зр╕ер╕Ьр╕е
logs/             # process log + fail log (CSV) + Graph debug (option)
mock-generator.js # р╕кр╕гр╣Йр╕▓р╕З ZIP р╕Хр╕▒р╕зр╕нр╕вр╣Ир╕▓р╕Зр╕кр╕│р╕лр╕гр╕▒р╕Ъ regression test
index.js          # Entry point р╕Др╕зр╕Ър╕Др╕╕р╕б lifecycle р╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Ф
```

## р╕Др╕зр╕▓р╕бр╕Хр╣Йр╕нр╕Зр╕Бр╕▓р╕гр╕гр╕░р╕Ър╕Ъ
- Node.js 20 р╕лр╕гр╕╖р╕нр╣Гр╕лр╕бр╣Ир╕Бр╕зр╣Ир╕▓
- р╕Хр╕┤р╕Фр╕Хр╕▒р╣Йр╕З dependency р╕Ир╕▓р╕Б `package.json` (`npm install`)
- р╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓р╣Др╕Яр╕ер╣М `.env` р╣Гр╕лр╣Йр╕Др╕гр╕Ъ (р╕Хр╕▒р╕зр╕нр╕вр╣Ир╕▓р╕Зр╕Хр╕▒р╕зр╣Бр╕Ыр╕гр╕кр╕│р╕Др╕▒р╕Н)
  - `GRAPH_TENANT_ID`, `GRAPH_CLIENT_ID`, `GRAPH_CLIENT_SECRET`
  - `MAIL_USER` (р╕Ър╕▒р╕Нр╕Кр╕╡р╕Чр╕╡р╣Ир╣Гр╕Кр╣Йр╕кр╣Ир╕Зр╣Ар╕бр╕ер╕Ьр╣Ир╕▓р╕Щ Graph)
  - `MS_SITE_ID`, `MS_SP_DRIVE_ID` (SharePoint Site/Drive)
  - `DB_HOST`, `DB_USER`, `DB_PASSWORD`, `DB_NAME`
- р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ъ `config/team.json` р╣Гр╕лр╣Йр╕Хр╕гр╕Зр╕Бр╕▒р╕Ър╣Вр╕Др╕гр╕Зр╕кр╕гр╣Йр╕▓р╕З OneDrive р╕Ир╕гр╕┤р╕З

## р╕Вр╕▒р╣Йр╕Щр╕Хр╕нр╕Щр╕Бр╕▓р╕гр╣Гр╕Кр╣Йр╕Зр╕▓р╕Щ
1. р╕Хр╕┤р╕Фр╕Хр╕▒р╣Йр╕З dependency: `npm install`
2. р╣Ар╕Хр╕гр╕╡р╕вр╕бр╣Др╕Яр╕ер╣М `.env` р╣Бр╕ер╕░р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ъ `config/team.json`
3. (р╕Чр╕▓р╕Зр╣Ар╕ер╕╖р╕нр╕Б) р╕гр╕▒р╕Щ `node mock-generator.js` р╣Ар╕Юр╕╖р╣Ир╕нр╕кр╕гр╣Йр╕▓р╕З ZIP р╕кр╕│р╕лр╕гр╕▒р╕Ър╕Чр╕Фр╕кр╕нр╕Ър╣Гр╕Щр╣Вр╕Яр╕ер╣Ар╕Фр╕нр╕гр╣М staging
4. р╣Ар╕гр╕╡р╕вр╕Бр╣Гр╕Кр╣Йр╕Зр╕▓р╕Щ: `node index.js`
   - р╕кр╕Др╕гр╕┤р╕Ыр╕Хр╣Мр╕Ир╕░р╕Фр╕▓р╕зр╕Щр╣Мр╣Вр╕лр╕ер╕Ф ZIP тЖТ р╕Ыр╕гр╕░р╕бр╕зр╕ер╕Ьр╕е тЖТ р╕нр╕▒р╕Ыр╣Вр╕лр╕ер╕Ф тЖТ р╕кр╣Ир╕Зр╕кр╕гр╕╕р╕Ы тЖТ р╣Ар╕Др╕ер╕╡р╕вр╕гр╣Мр╣Вр╕Яр╕ер╣Ар╕Фр╕нр╕гр╣Мр╕Кр╕▒р╣Ир╕зр╕Др╕гр╕▓р╕зр╣Бр╕ер╕░ `output/`
5. р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ъ log р╣Гр╕Щ `logs/` р╣Бр╕ер╕░р╕нр╕╡р╣Ар╕бр╕ер╕кр╕гр╕╕р╕Ыр╕зр╣Ир╕▓р╕Цр╕╣р╕Бр╕кр╣Ир╕Зр╕Др╕гр╕Ър╕Цр╣Йр╕зр╕Щ

> **р╕лр╕бр╕▓р╕вр╣Ар╕лр╕Хр╕╕:** р╕Бр╕▓р╕гр╕нр╕▒р╕Ыр╣Вр╕лр╕ер╕Фр╣Бр╕ер╕░р╕кр╣Ир╕Зр╕нр╕╡р╣Ар╕бр╕ер╕Хр╣Йр╕нр╕Зр╣Ар╕Ыр╕┤р╕Фр╕кр╕┤р╕Чр╕Шр╕┤р╣Мр╣Гр╕лр╣Й App р╕Ър╕Щ Microsoft Graph р╣Др╕зр╣Йр╣Ар╕гр╕╡р╕вр╕Ър╕гр╣Йр╕нр╕в р╣Бр╕ер╕░р╣Ар╕Др╕гр╕╖р╣Ир╕нр╕Зр╕Хр╣Йр╕нр╕Зр╣Ар╕Вр╣Йр╕▓р╕Цр╕╢р╕Зр╣Ар╕Др╕гр╕╖р╕нр╕Вр╣Ир╕▓р╕вр╕ар╕▓р╕вр╣Гр╕Щр╣Др╕Фр╣Й

## р╕Бр╕▓р╕гр╕Чр╕Фр╕кр╕нр╕Ър╣Бр╕ер╕░ Regression
- `mock-generator.js` р╕Ир╕░р╕кр╕гр╣Йр╕▓р╕З ZIP 20 р╣Др╕Яр╕ер╣М р╕Др╕гр╕нр╕Ър╕Др╕ер╕╕р╕бр╕Бр╕гр╕Ур╕╡ JPG/PNG/PDF/TIFF (р╕гр╕зр╕б multi-page) р╣Ар╕Юр╕╖р╣Ир╕нр╣Гр╕Кр╣Йр╕Чр╕Фр╕кр╕нр╕Ъ pipeline
- TIFF multi-page р╕Цр╕╣р╕Бр╣Бр╕вр╕Бр╣Ар╕Ыр╣Зр╕Щр╕лр╕ер╕▓р╕вр╕лр╕Щр╣Йр╕▓ PDF р╕Ьр╣Ир╕▓р╕Щ `convertTiffToPdfs`
- р╕Бр╕▓р╕гр╣Бр╕Ыр╕ер╕Зр╕гр╕╣р╕Ыр╣Бр╕ер╕░р╕гр╕зр╕б PDF р╣Гр╕Кр╣Й `pdf-lib` + `sharp` р╕Ир╕╢р╕Зр╕Др╕зр╕гр╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕Бр╕▓р╕гр╕Хр╕┤р╕Фр╕Хр╕▒р╣Йр╕З dependency р╣Ар╕лр╕ер╣Ир╕▓р╕Щр╕╡р╣Йр╣Гр╕Щр╕кр╕ар╕▓р╕Юр╣Бр╕зр╕Фр╕ер╣Йр╕нр╕бр╣Ар╕Ыр╣Йр╕▓р╕лр╕бр╕▓р╕в (р╣Ар╕Кр╣Ир╕Щ WSL)

## Logging & Error Handling
- `logger.js` р╕Бр╕гр╕░р╕Ир╕▓р╕в log р╕гр╕░р╕Фр╕▒р╕Ъ info/warn/error р╕Хр╕ер╕нр╕Ф pipeline
- `appendFailLog` р╕Ир╕░р╕кр╕гр╣Йр╕▓р╕Зр╣Др╕Яр╕ер╣М CSV р╕гр╕▓р╕вр╣Ар╕Фр╕╖р╕нр╕Щ (`logs/fail_YYYYMM.csv`) р╕кр╕│р╕лр╕гр╕▒р╕Ър╣Бр╕Хр╣Ир╕ер╕░р╕Вр╣Йр╕нр╕Ьр╕┤р╕Фр╕Юр╕ер╕▓р╕Ф
- р╕бр╕╡р╕Бр╕▓р╕гр╕Ир╕▒р╕Фр╕Ыр╕гр╕░р╣Ар╕ар╕Ч error р╕Ьр╣Ир╕▓р╕Щ `classifyError` р╣Ар╕Юр╕╖р╣Ир╕нр╕Кр╣Ир╕зр╕в debug р╣Др╕Фр╣Йр╣Ар╕гр╣Зр╕зр╕Вр╕╢р╣Йр╕Щ
- р╕кр╕▓р╕бр╕▓р╕гр╕Цр╣Ар╕Ыр╕┤р╕Ф `debugMode` р╕Вр╕нр╕З Graph Logger р╣Ар╕Юр╕╖р╣Ир╕нр╣Ар╕Бр╣Зр╕Ъ response JSON р╕гр╕▓р╕в call р╣Др╕Фр╣Й

## р╕Др╕зр╕▓р╕бр╕Юр╕гр╣Йр╕нр╕бр╣Гр╕Кр╣Йр╕Зр╕▓р╕Щр╕Ър╕Щ WSL
р╣Вр╕Др╣Йр╕Фр╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Фр╣Ар╕Ыр╣Зр╕Щ JavaScript р╕Чр╕│р╕Зр╕▓р╕Щр╕Ър╕Щ Node.js р╣Др╕бр╣Ир╕Ьр╕╣р╕Бр╕Бр╕▒р╕Ър╕гр╕░р╕Ър╕Ър╕Ыр╕Пр╕┤р╕Ър╕▒р╕Хр╕┤р╕Бр╕▓р╕г р╕Ир╕╢р╕Зр╣Гр╕Кр╣Йр╕Зр╕▓р╕Щр╕Ър╕Щ WSL р╣Др╕Фр╣Йр╣Вр╕Фр╕в:
1. р╕Хр╕┤р╕Фр╕Хр╕▒р╣Йр╕З Node.js р╣Бр╕ер╕░ dependency (`npm install`)
2. р╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓ `.env` р╣Гр╕лр╣Йр╣Ар╕лр╕бр╕╖р╕нр╕Щр╣Ар╕Др╕гр╕╖р╣Ир╕нр╕Зр╕лр╕ер╕▒р╕Б
3. р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕зр╣Ир╕▓ WSL р╕кр╕▓р╕бр╕▓р╕гр╕Цр╣Ар╕Вр╣Йр╕▓р╕Цр╕╢р╕З OneDrive/SharePoint р╣Бр╕ер╕░р╕Рр╕▓р╕Щр╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Др╕Фр╣Йр╕Ьр╣Ир╕▓р╕Щр╣Ар╕Др╕гр╕╖р╕нр╕Вр╣Ир╕▓р╕в
4. р╕гр╕▒р╕Щ `node index.js` р╣Ар╕Юр╕╖р╣Ир╕нр╕вр╕╖р╕Щр╕вр╕▒р╕Щр╕Бр╕▓р╕гр╕Чр╕│р╕Зр╕▓р╕Щ end-to-end

## р╕кр╕Цр╕▓р╕Щр╕░р╕Зр╕▓р╕Щр╕Хр╕▓р╕б Task Tracker
| Category | Task | Status | Note / Next Step |
| --- | --- | --- | --- |
| ЁЯзк Testing | р╕кр╕гр╣Йр╕▓р╕З mock ZIP 20 р╣Др╕Яр╕ер╣М тЖТ `mock-generator.js` | тЬЕ Done | р╣Гр╕Кр╣Йр╕кр╕│р╕лр╕гр╕▒р╕Ъ regression test |
| ЁЯзк Testing | р╣Ар╕Юр╕┤р╣Ир╕б mock TIFF multi-page | тЬЕ Done | р╕Чр╕Фр╕кр╕нр╕Ър╕Ьр╣Ир╕▓р╕Щ `imageHelper` + `pdfHelper` |
| ЁЯЫа Core Processing | ZIP extract, parsing, imageтЖТPDF, merge, naming, DB lookup | тЬЕ Done | р╕Др╕гр╕нр╕Ър╕Др╕ер╕╕р╕бр╣Др╕Яр╕ер╣М helper р╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Ф |
| ЁЯЫа Core Processing | Append summary CSV | тЬЕ Done | `appendSummaryRow` + SharePoint URL |
| ЁЯзй Processing Controller | `processor.js` pipeline | тЬЕ Done | р╣Гр╕Кр╣Йр╣Гр╕Щ `runPipeline()` |
| ЁЯУБ Structure | staging/temp/output + OneDrive Archive/Failed | тЬЕ Done | р╕бр╕╡ ensure & move helper |
| тЪЩя╕П Execution & Runtime | master loop, cleanup | тЬЕ Done | `index.js` р╣Ар╕Ыр╣Зр╕Щ entry point р╣Гр╕лр╕бр╣И |
| ЁЯУЭ Logging & Error Handling | process log, fail log, error classification | тЬЕ Done | р╕бр╕╡ logger р╣Бр╕ер╕░ fail log CSV |
| тШБя╕П MS Graph Integration | OAuth, OneDrive, SharePoint upload/patch, mail | тЬЕ Done | р╕кр╣Ир╕Зр╣Ар╕бр╕ер╕Юр╕гр╣Йр╕нр╕б SharePoint URL |
| ЁЯУз Notification | summary CSV, grouping, email per scanner | тЬЕ Done | `sendSummary.js` |
| ЁЯУз Notification | р╕кр╕гр╕╕р╕Ы fail case р╕гр╕▓р╕вр╣Ар╕Фр╕╖р╕нр╕Щ | тП│ Pending | TODO: р╕кр╣Ир╕Зр╣Гр╕лр╣Й `cghrsystem@central.co.th` |
| ЁЯУД Documentation | README | тЬЕ Done | р╣Ар╕нр╕Бр╕кр╕▓р╕гр╕Щр╕╡р╣Й |
| ЁЯУД Documentation | LICENSE & package.json | тЬЕ Done | р╕бр╕╡р╣Гр╕Щр╣Вр╕Ыр╕гр╣Ар╕Ир╣Зр╕Бр╕Хр╣М |

р╕Ыр╕▒р╕Ир╕Ир╕╕р╕Ър╕▒р╕Щр╣Ар╕лр╕ер╕╖р╕нр╕Зр╕▓р╕Щр╣Ар╕Фр╕╡р╕вр╕зр╕Чр╕╡р╣Ир╕вр╕▒р╕З Pending р╕Др╕╖р╕нр╕Бр╕▓р╕гр╕кр╣Ир╕Зр╕кр╕гр╕╕р╕Ы failure р╕гр╕▓р╕вр╣Ар╕Фр╕╖р╕нр╕Щр╣Гр╕лр╣Йр╕Чр╕╡р╕б HRIS
